<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Search</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: #f5f7fb;
        }

        .navbar-dark {
            background: #1f2937;
        }

        .card {
            border: 0;
            border-radius: 14px;
        }

        .video-card {
            border: 1px solid #e7e7e7;
            border-radius: 14px;
            padding: 14px;
            background: #fff;
        }

        .thumb {
            width: 160px;
            height: 90px;
            object-fit: cover;
            border-radius: 10px;
        }

        .small-muted {
            color: #6b7280;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-dark px-3">
        <a class="navbar-brand fw-semibold" href="index.html">YouTube Playlists</a>

        <div class="d-flex align-items-center gap-2 ms-auto">
            <div class="text-white me-2">Hello, <span id="helloUser" class="fw-bold">...</span></div>
            <a class="btn btn-outline-light btn-sm" href="playlists.html">My Playlists</a>
            <button id="logoutBtn" class="btn btn-danger btn-sm">Logout</button>
        </div>
    </nav>

    <div class="container py-4">
        <div id="msgBox" class="alert d-none" role="alert"></div>

        <div class="card shadow-sm p-4 mb-3">
            <div class="row g-2 align-items-center">
                <div class="col-md-9">
                    <input id="q" class="form-control form-control-lg" placeholder="Search YouTube videos..." />
                    <div class="small-muted mt-2">
                        Tip: the search term is saved in the URL (query string) so refreshing keeps results.
                    </div>
                </div>
                <div class="col-md-3 d-grid">
                    <button id="searchBtn" class="btn btn-primary btn-lg">Search</button>
                </div>
            </div>

            <div class="row g-2 mt-3 align-items-center">
                <div class="col-md-6">
                    <label class="form-label mb-1">Add results to playlist:</label>
                    <select id="playlistSelect" class="form-select"></select>
                </div>
            </div>
        </div>

        <div id="results" class="d-grid gap-3"></div>
    </div>

    <script>
        // ---- helpers ----
        function showMsg(type, text) {
            const box = document.getElementById("msgBox");
            box.className = "alert alert-" + type;
            box.textContent = text;
            box.classList.remove("d-none");
        }

        function hideMsg() {
            document.getElementById("msgBox").classList.add("d-none");
        }

        function setQueryParam(key, value) {
            const url = new URL(window.location.href);
            if (value) url.searchParams.set(key, value);
            else url.searchParams.delete(key);
            window.history.replaceState({}, "", url.toString());
        }

        function getQueryParam(key) {
            return new URL(window.location.href).searchParams.get(key) || "";
        }

        // ---- auth check ----
        async function ensureLoggedIn() {
            const res = await fetch("/api/me");
            const data = await res.json();

            if (!data.loggedIn) {
                sessionStorage.removeItem("currentUser");
                window.location.href = "login.html";
                return null;
            }
            return data.user;
        }

        // ---- playlists from server ----
        async function loadPlaylists() {
            const res = await fetch("/api/playlists");
            const data = await res.json();

            if (!res.ok) {
                showMsg("danger", data.error || "Failed to load playlists");
                return [];
            }

            const select = document.getElementById("playlistSelect");
            select.innerHTML = "";

            const playlists = data.playlists || [];
            for (const p of playlists) {
                const opt = document.createElement("option");
                opt.value = p.id;
                opt.textContent = p.name;
                select.appendChild(opt);
            }

            if (playlists.length === 0) {
                const opt = document.createElement("option");
                opt.value = "";
                opt.textContent = "No playlists (create one in My Playlists)";
                select.appendChild(opt);
            }

            return playlists;
        }

        // ---- YouTube search (replace if you already have your own implementation) ----
        // IMPORTANT: This is a placeholder. If your project already has YouTube API working,
        // keep your existing code and only use addToPlaylist() below.
        async function fakeSearch(query) {
            // Demo results so the page works even without API key.
            // Replace with your real YouTube API logic.
            return [
                {
                    videoId: "dQw4w9WgXcQ",
                    title: "Sample Video (Replace with your API results)",
                    thumbnailUrl: "https://img.youtube.com/vi/dQw4w9WgXcQ/mqdefault.jpg",
                    duration: "",
                    views: ""
                }
            ];
        }

        // ---- add item to playlist (SERVER) ----
        async function addToPlaylist(playlistId, video) {
            const res = await fetch(`/api/playlists/${encodeURIComponent(playlistId)}/items`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    type: "youtube",
                    videoId: video.videoId,
                    title: video.title,
                    thumbnailUrl: video.thumbnailUrl || "",
                    duration: video.duration || "",
                    views: video.views || ""
                })
            });

            const data = await res.json();

            if (!res.ok) {
                showMsg("warning", data.error || "Failed to add video");
                return false;
            }

            showMsg("success", "Video added to playlist!");
            return true;
        }

        function renderResults(videos) {
            const container = document.getElementById("results");
            container.innerHTML = "";

            if (!videos.length) {
                container.innerHTML = `<div class="text-muted">No results.</div>`;
                return;
            }

            for (const v of videos) {
                const el = document.createElement("div");
                el.className = "video-card";

                el.innerHTML = `
          <div class="d-flex gap-3 flex-wrap">
            <img class="thumb" src="${v.thumbnailUrl || ""}" alt="thumbnail">
            <div class="flex-grow-1">
              <div class="fw-semibold">${v.title}</div>
              <div class="small-muted mt-1">Video ID: ${v.videoId}</div>
              <div class="mt-3 d-flex gap-2 flex-wrap">
                <a class="btn btn-outline-secondary btn-sm" target="_blank"
                   href="https://www.youtube.com/watch?v=${encodeURIComponent(v.videoId)}">
                  Open on YouTube
                </a>
                <button class="btn btn-primary btn-sm addBtn">Add to selected playlist</button>
              </div>
            </div>
          </div>
        `;

                el.querySelector(".addBtn").addEventListener("click", async () => {
                    hideMsg();
                    const playlistId = document.getElementById("playlistSelect").value;
                    if (!playlistId) {
                        showMsg("warning", "Please select a playlist first.");
                        return;
                    }
                    await addToPlaylist(playlistId, v);
                });

                container.appendChild(el);
            }
        }

        // ---- main ----
        (async () => {
            const user = await ensureLoggedIn();
            if (!user) return;

            // UI username (prefer server session user, fallback to sessionStorage)
            document.getElementById("helloUser").textContent = user.username || "user";

            await loadPlaylists();

            // load query from URL
            const initialQ = getQueryParam("q");
            if (initialQ) {
                document.getElementById("q").value = initialQ;
                const videos = await fakeSearch(initialQ);
                renderResults(videos);
            }

            document.getElementById("searchBtn").addEventListener("click", async () => {
                hideMsg();
                const q = document.getElementById("q").value.trim();
                setQueryParam("q", q);

                if (!q) {
                    renderResults([]);
                    showMsg("warning", "Type a search term.");
                    return;
                }

                const videos = await fakeSearch(q);
                renderResults(videos);
            });

            document.getElementById("logoutBtn").addEventListener("click", async () => {
                await fetch("/api/logout", { method: "POST" });
                sessionStorage.removeItem("currentUser");
                window.location.href = "login.html";
            });
        })();
    </script>
</body>

</html>