<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Register</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: #f5f7fb;
        }

        .card {
            border: 0;
            border-radius: 14px;
        }

        .form-text {
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <div class="container py-5" style="max-width: 900px;">
        <div class="card shadow-sm p-4 p-md-5">
            <h1 class="display-6 text-center mb-4">Register</h1>

            <div id="msgBox" class="alert d-none" role="alert"></div>

            <form id="registerForm" novalidate>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Username <span class="text-danger">*</span></label>
                        <input id="username" class="form-control" type="text" autocomplete="username" required>
                        <div class="invalid-feedback">Username is required.</div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Email <span class="text-danger">*</span></label>
                        <input id="email" class="form-control" type="email" autocomplete="email" required>
                        <div class="invalid-feedback">Email is required.</div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Password <span class="text-danger">*</span></label>
                        <input id="password" class="form-control" type="password" autocomplete="new-password" required>
                        <div class="form-text">
                            Minimum 6 chars, must include at least 1 letter, 1 number, and 1 special character.
                        </div>
                        <div class="invalid-feedback">Password is required.</div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Confirm Password <span class="text-danger">*</span></label>
                        <input id="confirmPassword" class="form-control" type="password" autocomplete="new-password"
                            required>
                        <div class="invalid-feedback">Confirm password is required.</div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">First Name <span class="text-danger">*</span></label>
                        <input id="firstName" class="form-control" type="text" autocomplete="given-name" required>
                        <div class="invalid-feedback">First name is required.</div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Image URL <span class="text-danger">*</span></label>
                        <input id="imageUrl" class="form-control" type="url" placeholder="https://..." required>
                        <div class="invalid-feedback">Image URL is required.</div>
                    </div>
                </div>

                <div class="d-flex flex-wrap gap-2 mt-4">
                    <button class="btn btn-success px-4" type="submit">Create Account</button>
                    <a class="btn btn-outline-secondary" href="login.html">Already have an account?</a>
                    <a class="btn btn-link ms-auto" href="index.html">Home</a>
                </div>
            </form>
        </div>
    </div>

    <script>
        function showMsg(type, text) {
            const box = document.getElementById("msgBox");
            box.className = "alert alert-" + type;
            box.textContent = text;
            box.classList.remove("d-none");
        }

        function passwordIsValid(pw) {
            const hasLetter = /[A-Za-z]/.test(pw);
            const hasNumber = /[0-9]/.test(pw);
            const hasSpecial = /[^A-Za-z0-9]/.test(pw);
            return typeof pw === "string" && pw.length >= 6 && hasLetter && hasNumber && hasSpecial;
        }

        function clearInvalid() {
            const ids = ["username", "email", "password", "confirmPassword", "firstName", "imageUrl"];
            for (const id of ids) {
                const el = document.getElementById(id);
                el.classList.remove("is-invalid");
            }
        }

        document.getElementById("registerForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            clearInvalid();

            const username = document.getElementById("username").value.trim();
            const email = document.getElementById("email").value.trim();
            const firstName = document.getElementById("firstName").value.trim();
            const imageUrl = document.getElementById("imageUrl").value.trim();
            const password = document.getElementById("password").value;
            const confirmPassword = document.getElementById("confirmPassword").value;

            let ok = true;
            if (!username) { document.getElementById("username").classList.add("is-invalid"); ok = false; }
            if (!email) { document.getElementById("email").classList.add("is-invalid"); ok = false; }
            if (!firstName) { document.getElementById("firstName").classList.add("is-invalid"); ok = false; }
            if (!imageUrl) { document.getElementById("imageUrl").classList.add("is-invalid"); ok = false; }
            if (!password) { document.getElementById("password").classList.add("is-invalid"); ok = false; }
            if (!confirmPassword) { document.getElementById("confirmPassword").classList.add("is-invalid"); ok = false; }

            if (!ok) {
                showMsg("danger", "Please fill all required fields.");
                return;
            }

            if (!passwordIsValid(password)) {
                document.getElementById("password").classList.add("is-invalid");
                showMsg("danger", "Password does not meet the requirements.");
                return;
            }

            if (password !== confirmPassword) {
                document.getElementById("confirmPassword").classList.add("is-invalid");
                showMsg("danger", "Passwords do not match.");
                return;
            }

            try {
                const res = await fetch("/api/register", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password, email, firstName, imageUrl })
                });

                const data = await res.json();

                if (!res.ok) {
                    showMsg("warning", data.error || "Register failed.");
                    return;
                }

                showMsg("success", "Account created successfully. Redirecting to login...");
                setTimeout(() => window.location.href = "login.html", 900);

            } catch (err) {
                console.error(err);
                showMsg("danger", "Server/network error. Check console.");
            }
        });
    </script>
</body>

</html>